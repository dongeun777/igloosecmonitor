<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="igloosec.monitor.mapper.HomeMapper">
    <select id="selectUsage" parameterType="UsageVo" resultType="UsageVo">
        SELECT substring(event_date,9,2) AS idate ,round(event_volume/1024/1024) AS usage_data FROM ERD.tm_stats
        WHERE event_date LIKE '${paramDate}%' AND rscgrp ='${rscparam}'
    </select>


    <select id="selectUsagebefore" parameterType="UsageVo"  resultType="UsageVo">
        SELECT substring(event_date,9,2) AS idate ,round(event_volume/1024/1024) AS usage_data FROM ERD.tm_stats
        WHERE event_date LIKE '${paramDate}%' AND rscgrp ='${rscparam}'
    </select>


    <select id="selectMeterDetail" parameterType="UsageVo" resultType="UsageVo">
        SELECT meterCategory,'Storage' as meterSubCategory,CONCAT(ROUND(quantity,2)*10,'K' ) AS quantity, unitOfMeasure FROM(

             SELECT meterCategory,meterSubCategory, sum(quantity) AS quantity, unitOfMeasure FROM ERD.USED_AMOUNT
             WHERE substring(DATE,1,2) ='${paraMonth}' AND substring(DATE,7,10) ='${paraYear}' and resourceGroupName ='${rscparam}'
             GROUP BY meterCategory, unitOfMeasure, meterSubCategory ORDER BY quantity desc
        )a where quantity <![CDATA[>=]]> 0.01 and meterSubCategory LIKE '%Managed Disks' and unitOfMeasure ='10K'
        UNION
        SELECT meterCategory,'Virtual Machines' as meterSubCategory,CONCAT(ROUND(quantity,2)*10 , CASE WHEN unitOfMeasure Like '10%' THEN substring(unitOfMeasure,3,5) WHEN unitOfMeasure LIKE '1 %' THEN substring(unitOfMeasure,3,10) ELSE substring(unitOfMeasure,2,10) END ) AS quantity, unitOfMeasure FROM(

            SELECT meterCategory,meterSubCategory, sum(quantity) AS quantity, unitOfMeasure FROM ERD.USED_AMOUNT
            WHERE substring(DATE,1,2) ='${paraMonth}' AND substring(DATE,7,10) ='${paraYear}' and resourceGroupName ='${rscparam}'
            GROUP BY meterCategory, unitOfMeasure, meterSubCategory ORDER BY quantity desc
        )b where quantity <![CDATA[>=]]> 0.01 and meterSubCategory LIKE 'Virtual Machines%'
        UNION
        SELECT meterCategory, meterSubCategory,CONCAT(ROUND(quantity,2)*10 , CASE WHEN unitOfMeasure Like '10%' THEN substring(unitOfMeasure,3,5) WHEN unitOfMeasure LIKE '1 %' THEN substring(unitOfMeasure,3,10) ELSE substring(unitOfMeasure,2,10) END ) AS quantity, unitOfMeasure FROM(

         SELECT meterCategory,meterSubCategory, sum(quantity) AS quantity, unitOfMeasure FROM ERD.USED_AMOUNT
         WHERE substring(DATE,1,2) ='${paraMonth}' AND substring(DATE,7,10) ='${paraYear}' and resourceGroupName ='${rscparam}' and meterSubCategory NOT LIKE 'Virtual Machines%'
         GROUP BY meterCategory, unitOfMeasure, meterSubCategory ORDER BY quantity desc
     )c where quantity <![CDATA[>=]]> 0.01 and meterSubCategory NOT LIKE '%Managed Disks'

    </select>


    <select id="selectMeterSum" parameterType="UsageVo"  resultType="UsageVo">
        SELECT meterCategory, round(SUM(costInBillingCurrency),2) as costInBillingCurrency FROM ERD.USED_AMOUNT
        WHERE substring(DATE,1,2) ='${paraMonth}' AND substring(DATE,7,10) ='${paraYear}' and resourceGroupName ='${rscparam}'
        GROUP BY meterCategory;

    </select>


    <select id="registerLog" parameterType="UsageVo">
        insert into ERD.USER_EQUIP_LIST (email, equip,usages,logid)
        values (#{emailparam}, #{equipparam},${usageparam},#{logid});
    </select>

    <select id="joinMember" parameterType="MemberVo">
        insert into USER_LIST (email, passwd,regDate,company,qrcord,secretkey)
        values (#{email}, #{passwd},NOW(),#{company},#{qrcord},#{secretkey});
    </select>

    <select id="checkMember" parameterType="MemberVo" resultType="MemberVo">
       select * from USER_LIST where email ='${email}'
    </select>


    <select id="checkResetMember" parameterType="MemberVo" resultType="MemberVo">
        select DISTINCT email  from USER_LIST A, leads_info B where customer_email =email and email='${email}' and CONCAT(customer_last_name,customer_first_name) ='${name}';
    </select>

    <select id="selectLogList" parameterType="UsageVo" resultType="UsageVo">
        select equip,usages,logid from ERD.USER_EQUIP_LIST where email ='${emailparam}'
    </select>

    <delete id="deleteLog" parameterType="String">
        delete from USER_EQUIP_LIST where logid = #{logid};
    </delete>


    <update id="completeLog" parameterType="MemberVo">
        update USER_LIST SET step = 1 where email = #{email};

    </update>

    <update id="completeLog2" parameterType="MemberVo">
        update USER_LIST SET step = 2 where email = #{email};

    </update>

    <update id="goBack" parameterType="String">
        update USER_LIST SET step = 0 where email = #{email};

    </update>

    <update id="resetPass" parameterType="MemberVo">
        update USER_LIST SET passwd = #{passwd} where email = #{email};

    </update>


    <select id="selectCostTotal" parameterType="UsageVo" resultType="UsageVo">
        SELECT round(costtotal* (SELECT exchangeRatePricingToBilling FROM USED_AMOUNT ORDER BY DATE DESC LIMIT 1),-3) AS costtotal,
               round(oneyearCostTotal* (SELECT exchangeRatePricingToBilling FROM USED_AMOUNT ORDER BY DATE DESC LIMIT 1),-3) AS oneyearCostTotal,
               round(threeyearCostTotal* (SELECT exchangeRatePricingToBilling FROM USED_AMOUNT ORDER BY DATE DESC LIMIT 1),-3) AS threeyearCostTotal,
               cpu, ram, disk, vmseries, pathStr, shellcom
        FROM azurecost WHERE beforeSize<![CDATA[<]]> #{usageparam} AND #{usageparam}<![CDATA[<=]]>logSize;
    </select>

    <select id="selectPath"  resultType="String">
        SELECT pathStr
        FROM azurecost
        LIMIT 1
    </select>


    <select id="getGrpList"  resultType="MemberVo">
        SELECT rscGrp,company,email
        FROM USER_LIST

    </select>

    <select id="selectSecretKey"  parameterType="MemberVo" resultType="String">
        SELECT secretkey
        FROM USER_LIST where email = #{email};
    </select>

    <select id="selectQrCord"  parameterType="MemberVo" resultType="String">
        SELECT qrcord
        FROM USER_LIST where email = #{email};
    </select>

    <select id="selectMember" resultType="MemberVo" parameterType="String">
        SELECT * FROM USER_LIST
        where email = #{email}
    </select>



</mapper>


