<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="igloosec.monitor.mapper.HomeMapper">
    <select id="selectUsage" parameterType="UsageVo" resultType="UsageVo">
        SELECT substring(event_date,9,2) AS idate ,round(event_volume/1024/1024) AS usage_data FROM ERD.tm_stats
        WHERE event_date LIKE '${paramDate}%' AND rscgrp ='${rscparam}'
    </select>


    <select id="selectUsagebefore" parameterType="UsageVo"  resultType="UsageVo">
        SELECT substring(event_date,9,2) AS idate ,round(event_volume/1024/1024) AS usage_data FROM ERD.tm_stats
        WHERE event_date LIKE '${paramDate}%' AND rscgrp ='${rscparam}'
    </select>


    <select id="selectMeterDetail" parameterType="UsageVo" resultType="UsageVo">
        SELECT meterCategory,meterSubCategory,ROUND(quantity,2) AS quantity, unitOfMeasure FROM(

             SELECT meterCategory,meterSubCategory, sum(quantity) AS quantity, unitOfMeasure FROM ERD.USED_AMOUNT
             WHERE substring(DATE,1,2) ='${paraMonth}' AND substring(DATE,7,10) ='${paraYear}' and resourceGroupName ='${rscparam}'
             GROUP BY meterCategory, unitOfMeasure, meterSubCategory ORDER BY quantity desc
        )a where quantity <![CDATA[>=]]> 0.01
    </select>


    <select id="selectMeterSum" parameterType="UsageVo"  resultType="UsageVo">
        SELECT meterCategory, round(SUM(costInBillingCurrency),2) as costInBillingCurrency FROM ERD.USED_AMOUNT
        WHERE substring(DATE,1,2) ='${paraMonth}' AND substring(DATE,7,10) ='${paraYear}' and resourceGroupName ='${rscparam}'
        GROUP BY meterCategory;

    </select>


    <select id="registerLog" parameterType="UsageVo">
        insert into ERD.USER_EQUIP_LIST (email, equip,usages)
        values (#{emailparam}, #{equipparam},${usageparam});
    </select>

    <select id="joinMember" parameterType="MemberVo">
        insert into USER_LIST (email, passwd,regDate,company)
        values (#{email}, #{passwd},NOW(),#{company});
    </select>

    <select id="checkMember" parameterType="MemberVo" resultType="MemberVo">
       select * from USER_LIST where email ='${email}'
    </select>

    <select id="selectLogList" parameterType="UsageVo" resultType="UsageVo">
        select equip,usages from ERD.USER_EQUIP_LIST where email ='${emailparam}'
    </select>

    <update id="completeLog" parameterType="MemberVo">
        update USER_LIST SET step = 1 where email = #{email};

    </update>

    <update id="completeLog2" parameterType="MemberVo">
        update USER_LIST SET step = 2 where email = #{email};

    </update>


    <select id="selectCostTotal" parameterType="UsageVo" resultType="UsageVo">
        SELECT round(costtotal* (SELECT exchangeRatePricingToBilling FROM USED_AMOUNT ORDER BY DATE DESC LIMIT 1),-3) AS costtotal, cpu, ram, disk, vmseries, pathStr, shellcom
        FROM azurecost WHERE beforeSize<![CDATA[<]]> #{usageparam} AND #{usageparam}<![CDATA[<=]]>logSize;
    </select>

    <select id="selectPath"  resultType="String">
        SELECT pathStr
        FROM azurecost
        LIMIT 1
    </select>


    <select id="getGrpList"  resultType="MemberVo">
        SELECT rscGrp,company,email
        FROM USER_LIST

    </select>



</mapper>


